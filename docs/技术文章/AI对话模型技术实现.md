---
title: ä»SSEåˆ°æ‰“å­—æœºâ€”â€”AIåœºæ™¯ä¸‹å‰ç«¯çš„å®ç°é€»è¾‘ä¸å®è·µ
tags:
  - æ–¹æ³•è®º
createTime: 2025/06/21 15:10:35
permalink: /article/glqagb8o/
---
éšç€Deepseekçš„æ¨ªç©ºå‡ºä¸–ï¼Œè®©æ¯ä¸ªäººéƒ½æœ‰äº†æ„å»ºè‡ªå·±AIçŸ¥è¯†åº“çš„é€”å¾„ï¼Œä½œä¸ºä¸€ä¸ªå‰ç«¯å¼€å‘è€…ï¼Œå®Œå…¨å¯ä»¥é€šè¿‡å¤§æ¨¡å‹æ„å»ºè‡ªå·±çš„æ—¥å¸¸å­¦ä¹ çŸ¥è¯†åº“ï¼Œç„¶åè‡ªå·±å†™ä¸€ä¸ªAIçš„äº¤äº’é¡µé¢æ„å»ºè‡ªå·±çš„ ChatGPT ï¼Œå½“ç„¶è¯´åˆ°è¿™ï¼Œè‚¯å®šæœ‰äººè¯´ç°åœ¨æœ‰ä¸€é”®æ„å»ºçš„å¼€æºé¡¹ç›®ä¸ºä»€ä¹ˆä¸ç”¨å‘¢ï¼Œè¯´ç™½äº†æŠ€æœ¯è¿˜æ˜¯è¦è‡ªå·±å®ç°æ‰èƒ½æ›´åŠ æ·±å…¥åœ°ç†è§£ï¼Œå¹¶ä¸”æ›´åŠ çµæ´»åœ°è¿ç”¨åˆ°æ—¥å¸¸å­¦ä¹ æˆ–è€…å®é™…ä¸šåŠ¡åœºæ™¯ä¸­å»ã€‚



æœ¬ç¯‡æ–‡ç« åªä»å‰ç«¯çš„è§’åº¦å‡ºå‘ï¼Œåˆ†æå®ç°ä¸€ä¸ªAIçš„äº¤äº’é¡µé¢èƒ½ç”¨åˆ°å“ªäº›æŠ€æœ¯ï¼Œæœ€åå†å»å®ç°ä¸€ä¸ªAIåœºæ™¯é¡µé¢ã€‚

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥[ç‚¹å‡»è¿™é‡Œ](https://jyqwq.github.io/rainbow/AIChat/)ç›´æ¥æŸ¥çœ‹æœ¬ç¯‡æ–‡ç« å®ç°çš„é¡µé¢ã€‚

å¦‚æœæ‰“ä¸å¼€ï¼Œè¿™é‡Œè¿˜æœ‰è´´å¿ƒå›½å†…æœåŠ¡å™¨çš„[å¤‡ç”¨é“¾æ¥](https://file.40017.cn/baoxian/rainbow/AIChat/index.html)ã€‚

*<u>PSï¼šä¸Šé¢ä¸¤ä¸ªæ¼”ç¤ºé“¾æ¥éƒ½æ˜¯ç”¨ `vuepress` å®ç°çš„ä¸ªäººåšå®¢ï¼Œæ„Ÿè§‰ç”¨è¿™å¥—æ¡†æ¶å®ç°è‡ªå®šä¹‰ç»„ä»¶é‡Œé¢çš„å‘è¿˜æŒºå¤šäº†ï¼Œæœ‰æœºä¼šå¯ä»¥å†å†™ä¸€ç¯‡å…³äº `vuepress` çš„å¼€å‘é¿å‘æ–‡ç« ã€‚</u>*



å½“ç„¶ï¼Œå…³äºIMçš„äº¤äº’é€»è¾‘åœ¨æˆ‘ä¹‹å‰çš„æ–‡ç«  [ã€ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ªè…¾è®¯IMå³æ—¶é€šè®¯ç»„ä»¶ï¼ˆæ— UIè®¾è®¡æ–¹æ¡ˆï¼‰~ã€‘](https://juejin.cn/post/7329036627606913036)ä¸­å·²ç»è¯¦ç»†æè¿°äº†å®ç°è¿‡ç¨‹ï¼Œæ‰€ä»¥ï¼Œè¿™ç¯‡æ–‡ç« å°±ä»å·²ç»å®ç°äº†IMäº¤äº’çš„é¡µé¢åŸºç¡€ä¸Šå¼€å§‹å®ç°AIåœºæ™¯ä¸‹çš„IMã€‚



### æŠ€æœ¯é€‰å‹



æ¶‰åŠåˆ°AIåœºæ™¯å¿…ç„¶ä¼šè”æƒ³åˆ°æ‰“å­—æœºæ•ˆæœçš„æµå¼è¾“å‡ºæ–‡æœ¬ï¼Œé‚£ä¹ˆå‰ç«¯å®ç°è¿™ç§æ•ˆæœæœ‰å“ªäº›æ–¹å¼å‘¢ï¼Ÿ



#### åè®®å¯¹æ¯”

é¦–å…ˆæœ€ç®€å•çš„ï¼Œé€šè¿‡è½®è¯¢æ¥å£ä¸æ–­è·å–æ•°æ®ï¼Œå…¶æ¬¡é€šè¿‡`websocket`ä¸æ–­è·å–ç›‘å¬åˆ°çš„æ•°æ®ï¼Œæœ€åé€šè¿‡æœåŠ¡ç«¯æ¶ˆæ¯æ¨é€è·å–æ•°æ®ã€‚è¿™ä¸‰ç§æ€è·¯å¯¹åº”ç€ä¸‰ç§é€šè®¯åè®®ï¼šHTTPã€WebSocketã€SSEã€‚

å…ˆå¯¹æ¯”ä¸€ä¸‹è¿™ä¸‰ç§åè®®ï¼š



**åŸºæœ¬æ¦‚å¿µä¸é€šä¿¡æ¨¡å¼**

| ç‰¹æ€§         | **HTTP**                   | **SSE (Server-Sent Events)**   | **WebSocket**                |
| ------------ | -------------------------- | ------------------------------ | ---------------------------- |
| **åè®®ç±»å‹** | æ— çŠ¶æ€çš„è¯·æ±‚ - å“åº”åè®®    | åŸºäº HTTP çš„å•å‘äº‹ä»¶æµåè®®     | åŸºäº TCP çš„å…¨åŒå·¥å®æ—¶åè®®    |
| **é€šä¿¡æ–¹å‘** | å®¢æˆ·ç«¯â†’æœåŠ¡å™¨ï¼ˆå•å‘ï¼‰      | æœåŠ¡å™¨â†’å®¢æˆ·ç«¯ï¼ˆå•å‘ï¼‰          | åŒå‘ï¼ˆå…¨åŒå·¥ï¼‰               |
| **è¿æ¥ç‰¹æ€§** | çŸ­è¿æ¥ï¼ˆæ¯æ¬¡è¯·æ±‚æ–°å»ºè¿æ¥ï¼‰ | é•¿è¿æ¥ï¼ˆå•æ¬¡è¯·æ±‚ï¼ŒæŒç»­å“åº”ï¼‰   | é•¿è¿æ¥ï¼ˆä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒç»­é€šä¿¡ï¼‰ |
| **å‘èµ·æ–¹å¼** | å®¢æˆ·ç«¯ä¸»åŠ¨è¯·æ±‚             | å®¢æˆ·ç«¯ä¸»åŠ¨è¯·æ±‚ï¼ŒæœåŠ¡å™¨æŒç»­æ¨é€ | å®¢æˆ·ç«¯å‘èµ·æ¡æ‰‹ï¼Œåç»­åŒå‘é€šä¿¡ |
| **å…¸å‹åœºæ™¯** | é™æ€èµ„æºè¯·æ±‚ã€API è°ƒç”¨     | å®æ—¶é€šçŸ¥ã€è‚¡ç¥¨è¡Œæƒ…ã€æ–°é—»æ¨é€   | å®æ—¶èŠå¤©ã€åœ¨çº¿æ¸¸æˆã€åä½œå·¥å…· |



**æŠ€æœ¯ç»†èŠ‚å¯¹æ¯”**

| ç‰¹æ€§             | **HTTP**                | **SSE**                     | **WebSocket**             |
| ---------------- | ----------------------- | --------------------------- | ------------------------- |
| **åè®®åŸºç¡€**     | HTTP/1.1 æˆ– HTTP/2      | HTTP/1.1 æˆ– HTTP/2          | WebSocket åè®® (RFC 6455) |
| **ç«¯å£**         | 80 (HTTP) / 443 (HTTPS) | 80/443                      | 80 (ws) / 443 (wss)       |
| **æ•°æ®æ ¼å¼**     | æ–‡æœ¬ã€JSONã€äºŒè¿›åˆ¶ç­‰    | çº¯æ–‡æœ¬ï¼ˆtext/event-streamï¼‰ | æ–‡æœ¬æˆ–äºŒè¿›åˆ¶ï¼ˆå¸§æ ¼å¼ï¼‰    |
| **äºŒè¿›åˆ¶æ”¯æŒ**   | æ”¯æŒï¼Œä½†éœ€é¢å¤–å¤„ç†      | ä¸æ”¯æŒï¼ˆéœ€ç¼–ç ä¸ºæ–‡æœ¬ï¼‰      | åŸç”Ÿæ”¯æŒ                  |
| **è‡ªåŠ¨é‡è¿**     | å¦ï¼ˆéœ€å®¢æˆ·ç«¯å®ç°ï¼‰      | æ˜¯ï¼ˆå†…ç½®æœºåˆ¶ï¼‰              | å¦ï¼ˆéœ€æ‰‹åŠ¨å®ç°ï¼‰          |
| **å¿ƒè·³æœºåˆ¶**     | å¦ï¼ˆéœ€è½®è¯¢ï¼‰            | å¦ï¼ˆéœ€è‡ªå®šä¹‰ï¼‰              | æ˜¯ï¼ˆPing/Pong å¸§ï¼‰        |
| **æµè§ˆå™¨å…¼å®¹æ€§** | å…¨å…¼å®¹                  | ç°ä»£æµè§ˆå™¨ï¼ˆIE ä¸æ”¯æŒï¼‰     | ç°ä»£æµè§ˆå™¨ï¼ˆIE 10+ï¼‰      |



**æ€§èƒ½ä¸æ•ˆç‡**

| ç‰¹æ€§              | **HTTP**                     | **SSE**                  | **WebSocket**            |
| ----------------- | ---------------------------- | ------------------------ | ------------------------ |
| **è¿æ¥å¼€é”€**      | é«˜ï¼ˆæ¯æ¬¡è¯·æ±‚éœ€é‡æ–°å»ºç«‹è¿æ¥ï¼‰ | ä¸­ï¼ˆä¸€æ¬¡è¿æ¥ï¼Œé•¿æœŸä¿æŒï¼‰ | ä½ï¼ˆä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒç»­é€šä¿¡ï¼‰ |
| **åè®® overhead** | é«˜ï¼ˆHTTP å¤´ä¿¡æ¯å†—ä½™ï¼‰        | ä½ï¼ˆä»…åˆå§‹å¤´ï¼‰           | ä¸­ï¼ˆå¸§å¤´å¼€é”€è¾ƒå°ï¼‰       |
| **å®æ—¶æ€§**        | ä½ï¼ˆä¾èµ–å®¢æˆ·ç«¯è½®è¯¢ï¼‰         | é«˜ï¼ˆæœåŠ¡å™¨ä¸»åŠ¨æ¨é€ï¼‰     | æé«˜ï¼ˆåŒå‘å®æ—¶ï¼‰         |
| **å¸¦å®½åˆ©ç”¨ç‡**    | ä½ï¼ˆè½®è¯¢å¯¼è‡´æ— æ•ˆè¯·æ±‚ï¼‰       | ä¸­ï¼ˆå•å‘æŒç»­ä¼ è¾“ï¼‰       | é«˜ï¼ˆæŒ‰éœ€åŒå‘ä¼ è¾“ï¼‰       |
| **å»¶è¿Ÿ**          | é«˜ï¼ˆè¯·æ±‚å“åº”å‘¨æœŸï¼‰           | ä¸­ï¼ˆæ¨é€å»¶è¿Ÿï¼‰           | ä½ï¼ˆé•¿è¿æ¥ç›´æ¥é€šä¿¡ï¼‰     |



#### APIé€‰æ‹©



å†æ¥å›çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„éœ€æ±‚ï¼ŒAIåœºæ™¯è¯´ç™½äº†ä¸€é—®ä¸€ç­”çš„æ–¹å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›å‘é€ä¸€æ¬¡è¯·æ±‚åï¼Œèƒ½å¤ŸæŒç»­è·å–æ•°æ®ï¼Œæœ¬æ¬¡è¯·æ±‚åç«¯ä¹Ÿåªéœ€è¦çŸ¥é“æˆ‘çš„é—®é¢˜å³å¯ï¼Œä¸éœ€è¦å’Œå‰ç«¯è¿›è¡Œå…¶ä»–äº¤äº’ï¼Œæ‰€ä»¥ `SSE` åœ¨è¿™ç§åœºæ™¯ä¸‹çš„ä¼˜åŠ¿å°±æ˜¾è€Œæ˜“è§äº†ã€‚



å‰ç«¯è¦åœ¨**æµè§ˆå™¨**ä¸­å®ç° `SSE` çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š

- `EventSource` API
- `fetch` API

`EventSource` å’Œ `fetch` éƒ½æ˜¯ç°ä»£ Web å¼€å‘ä¸­ç”¨äºä¸æœåŠ¡å™¨é€šä¿¡çš„ APIã€‚

| ç‰¹æ€§           | **EventSource (SSE)**        | **Fetch API**                |
| -------------- | ---------------------------- | ---------------------------- |
| **é€šä¿¡æ¨¡å¼**   | å•å‘ï¼ˆæœåŠ¡å™¨â†’å®¢æˆ·ç«¯ï¼‰        | åŒå‘ï¼ˆè¯·æ±‚â†’å“åº”ï¼‰            |
| **è¿æ¥ç‰¹æ€§**   | é•¿è¿æ¥ï¼ˆæŒç»­æ¥æ”¶æœåŠ¡å™¨æ¨é€ï¼‰ | çŸ­è¿æ¥ï¼ˆæ¯æ¬¡è¯·æ±‚æ–°å»ºè¿æ¥ï¼‰   |
| **æ•°æ®æµç±»å‹** | äº‹ä»¶æµï¼ˆæŒç»­ä¸æ–­ï¼‰           | ä¸€æ¬¡æ€§å“åº”ï¼ˆè¯·æ±‚å®Œæˆå³ç»“æŸï¼‰ |
| **æ•°æ®æ ¼å¼**   | æ–‡æœ¬ï¼ˆäº‹ä»¶æµæ ¼å¼ï¼‰           | ä»»æ„ï¼ˆJSONã€Blobã€æ–‡æœ¬ç­‰ï¼‰   |
| **è‡ªåŠ¨é‡è¿**   | å†…ç½®æ”¯æŒï¼ˆè‡ªåŠ¨é‡è¿æœºåˆ¶ï¼‰     | éœ€æ‰‹åŠ¨å®ç°                   |



`EventSource` APIå®ç°äº† `SSE` ã€‚æ¢å¥è¯è¯´ `EventSource` APIæ˜¯ `Web` å†…å®¹ä¸æœåŠ¡å™¨å‘é€äº‹ä»¶é€šä¿¡çš„æ¥å£ã€‚ä¸€ä¸ª`EventSource` å®ä¾‹ä¼šå¯¹HTTPæœåŠ¡å™¨å¼€å¯ä¸€ä¸ªæŒä¹…åŒ–çš„è¿æ¥ï¼Œä»¥ `text/event-stream` æ ¼å¼å‘é€äº‹ä»¶ï¼Œæ­¤è¿æ¥ä¼šä¸€ç›´ä¿æŒå¼€å¯ç›´åˆ°é€šè¿‡è°ƒç”¨ `EventSource.close()` å…³é—­ã€‚

ä½†æ˜¯å®ƒæœ‰ä¸€äº›é™åˆ¶ï¼š

- æ— æ³•ä¼ é€’è¯·æ±‚ä½“ `request body` ï¼Œå¿…é¡»å°†æ‰§è¡Œè¯·æ±‚æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ç¼–ç åˆ° URL ä¸­ï¼Œè€Œå¤§å¤šæ•°æµè§ˆå™¨å¯¹ URL çš„é•¿åº¦é™åˆ¶ä¸º 2000 ä¸ªå­—ç¬¦ã€‚
- æ— æ³•ä¼ é€’è‡ªå®šä¹‰è¯·æ±‚å¤´ã€‚
- åªèƒ½è¿›è¡Œ GET è¯·æ±‚ï¼Œæ— æ³•æŒ‡å®šå…¶ä»–æ–¹æ³•ã€‚
- å¦‚æœè¿æ¥ä¸­æ–­ï¼Œæ— æ³•æ§åˆ¶é‡è¯•ç­–ç•¥ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è¿›è¡Œå‡ æ¬¡å°è¯•ç„¶ååœæ­¢ã€‚



è€ŒAIåœºæ™¯å¸¸å¸¸ä¼šæœ‰ä¸€äº›å…¶ä»–éœ€æ±‚ï¼Œå¦‚ä¸Šæ–‡è®°å¿†ã€æ¥å£ `token` éªŒè¯ç­‰ç­‰ï¼Œäºæ˜¯ `fetch` æˆäº†æˆ‘ä»¬çš„æœ€ä½³é€‰æ‹©ã€‚

`fetch` APIå¯ä»¥é€šè¿‡è®¾ç½® `headers` æ”¯æŒæµå¼æ•°æ®çš„æ¥æ”¶ï¼Œç„¶åé€šè¿‡ `ReadableStreamDefaultReader` å¯¹è±¡ï¼Œé€å—è¯»å–å“åº”çš„æ•°æ®ã€‚



#### å¤§æ¨¡å‹é€‰æ‹©



ä½œä¸ºå‰ç«¯å¼€å‘æˆ‘ä»¬æ›´æ³¨é‡äºæ¨¡å‹çš„å®šåˆ¶åŒ–é…ç½®å’Œé¡µé¢çš„å±•ç¤ºæ•ˆæœä¸äº¤äº’ï¼Œé€šè¿‡ç¬¬ä¸‰æ–¹æ¨¡å‹å¯ä»¥å¿«é€Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œè¿™é‡Œæˆ‘é€‰ç”¨çš„æ˜¯[é˜¿é‡Œäº‘ç™¾ç‚¼](https://bailian.console.aliyun.com/)ã€‚

å®ƒç›´æ¥æä¾›äº†æ”¯æŒæµå¼è¾“å‡ºçš„æ¥å£ï¼Œåªéœ€è¦åœ¨è¯·æ±‚å¤´åŠ ä¸Š `X-DashScope-SSE:true` ã€‚æ¯”è¾ƒå‘çš„æ˜¯é˜¿é‡Œäº‘æ–‡æ¡£é‡Œé¢åªæä¾›äº† `node` çš„å†™æ³•ï¼Œå®é™…æµè§ˆå™¨ä¸­ `axios` å¹¶ä¸æ”¯æŒæµå¼ä¼ è¾“ã€‚

![image-20250621145616487](https://file.40017.cn/baoxian/health/health_public/images/blog/image-20250621145616487.png)



### APIè§£æ



#### AbortController

å‰é¢æˆ‘ä»¬è¯´åˆ° `SSE` çš„æ•°æ®ä¼ è¾“æ˜¯å•å‘çš„ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¼šæƒ³ä¸­æ–­æ¨é€ä¿¡æ¯çš„æ¥æ”¶ï¼Œå®é™…éœ€æ±‚å°±æ˜¯ä¸­æ–­AIå½“å‰å›ç­”ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ§åˆ¶å™¨æ¥æ›´åŠ ç²¾ç»†åœ°æ§åˆ¶æˆ‘ä»¬çš„è¯·æ±‚ã€‚

`AbortController` å¯¹è±¡çš„ä½œç”¨æ˜¯å¯¹ä¸€ä¸ªæˆ–å¤šä¸ª Web è¯·æ±‚è¿›è¡Œä¸­æ­¢æ“ä½œï¼Œåƒ `fetch` è¯·æ±‚ã€`ReadableStream` ä»¥åŠç¬¬ä¸‰æ–¹åº“çš„æ“ä½œéƒ½å¯ä»¥å–æ¶ˆã€‚

æ ¸å¿ƒæœºåˆ¶ï¼šå€ŸåŠ© `AbortSignal` æ¥å®ç°æ“ä½œçš„ä¸­æ­¢ã€‚`AbortController` ä¼šç”Ÿæˆä¸€ä¸ªä¿¡å·å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯è¢«ä¼ é€’ç»™è¯·æ±‚ï¼Œå½“è°ƒç”¨ `abort() `æ–¹æ³•æ—¶ï¼Œå°±ä¼šè§¦å‘è¯·æ±‚çš„å–æ¶ˆæ“ä½œã€‚



æœ‰äº†è¿™ä¸ªAPIæˆ‘ä»¬å°±å¯ä»¥å®ç°ä¸­æ–­å›ç­”æŒ‰é’®çš„å®ç°ã€‚

```js
const controller = new AbortController()
const response = await fetch(
  url: 'url',
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer token`,
      'X-DashScope-SSE': 'enable', // å…è®¸å®æ—¶æ¨é€
    },
    signal: controller.signal, // ä¿¡å·å¯¹è±¡ç»‘å®šè¯·æ±‚
    body: "{...}",
  }
)

setTimeout(()=> controller.abort(), 1000) // ä¸€ç§’é’Ÿåè‡ªåŠ¨ä¸­æ–­è¯·æ±‚
```



#### Reader

åœ¨è¯·æ±‚å‘å‡ºåï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½æŒç»­è·å–æ¨é€ä¿¡æ¯çš„å…¥å£ï¼Œ`fetch` çš„ `response.body.getReader` æ˜¯ `JavaScript` ä¸­ç”¨äºå¤„ç† `fetch` è¯·æ±‚å“åº”æµçš„æ–¹æ³•ï¼Œå®ƒå…è®¸ä½ ä»¥å¯æ§çš„æ–¹å¼é€å—è¯»å–å“åº”æ•°æ®ï¼Œè€Œéä¸€æ¬¡æ€§å¤„ç†æ•´ä¸ªå“åº”ã€‚è¿™åœ¨å¤„ç†å¤§æ–‡ä»¶ä¸‹è½½ã€å®æ—¶æ•°æ®æµï¼ˆå¦‚è§†é¢‘ã€SSEï¼‰æˆ–éœ€è¦æ¸è¿›å¼è§£ææ•°æ®çš„åœºæ™¯ä¸­ç‰¹åˆ«æœ‰ç”¨ã€‚ 

```js
// è·å–ä¸€ä¸ª ReadableStreamDefaultReader å¯¹è±¡ï¼Œç”¨äºé€å—è¯»å–å“åº”çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆUint8Arrayï¼‰ã€‚
const reader = response.body.getReader()

while (true) {
  // è¯»å–æ•°æ®å— æµæ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè¯»å–å®Œæˆåæ— æ³•å†æ¬¡è¯»å–
	const {done, value} = await reader.read();
  if (done) {
    console.log('æµè¯»å–å®Œæˆ');
    break;
  }
}

```

å¾ªç¯è°ƒç”¨ `read()` ä»¥è¾¾åˆ°è·å–å®Œæ•´æ•°æ®çš„éœ€æ±‚ï¼Œæ ¹æ® `done` åˆ¤æ–­æ˜¯å¦å·²ç»è¯»å–å®Œæ¯•ã€‚



#### TextDecoder

`TextDecoder` æ˜¯ `JavaScript` ä¸­ç”¨äºå°†äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚ `ArrayBuffer` æˆ– `Uint8Array`ï¼‰è§£ç ä¸ºäººç±»å¯è¯»çš„æ–‡å­—å­—ç¬¦ä¸²çš„å†…ç½®å¯¹è±¡ã€‚å®ƒæ”¯æŒå¤šç§å­—ç¬¦ç¼–ç ï¼ˆå¦‚ `UTF-8`ã€`ISO-8859-1`ã€`GBK` ç­‰ï¼‰ï¼Œæ˜¯å¤„ç†ç½‘ç»œå“åº”ã€æ–‡ä»¶è¯»å–ç­‰äºŒè¿›åˆ¶æ•°æ®è½¬æ¢çš„æ ‡å‡†å·¥å…·ã€‚

```js
// ä»»æ„äºŒè¿›åˆ¶æ•°æ®
const value = ...

// æµå¼è§£ç ï¼šæ”¯æŒåˆ†å—å¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼ˆé€šè¿‡å¤šæ¬¡è°ƒç”¨ decode æ–¹æ³•ï¼‰ã€‚
const decoder = new TextDecoder('UTF-8')
// è§£ç äºŒè¿›åˆ¶æ•°æ®ä¸ºæ–‡æœ¬
const chunk = decoder.decode(value, { stream: true })
```

å€¼å¾—æ³¨æ„çš„æ˜¯ `decode` çš„ `stream` å‚æ•°è®¾ç½®ä¸º `true` ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢ä¹±ç çš„æƒ…å†µï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“ `UTF-8` æ˜¯ä¸€ç§å˜é•¿ç¼–ç ï¼Œ**ASCII å­—ç¬¦ï¼ˆ0-127ï¼‰ç”¨ 1 ä¸ªå­—èŠ‚è¡¨ç¤º**ï¼Œè€Œå…¶ä»–å­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡ã€ emojiï¼‰å¯èƒ½ç”¨ **2-4 ä¸ªå­—èŠ‚**è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼š

- `ä¸­` çš„ UTF-8 ç¼–ç æ˜¯ `[228, 184, 150]`ï¼ˆ3 ä¸ªå­—èŠ‚ï¼‰ã€‚
- ğŸ˜Š çš„ UTF-8 ç¼–ç æ˜¯ `[240, 159, 152, 138]`ï¼ˆ4 ä¸ªå­—èŠ‚ï¼‰ã€‚

å½“æ•°æ®**åˆ†å—ä¼ è¾“**æ—¶ï¼Œä¸€ä¸ªå­—ç¬¦å¯èƒ½è¢«æˆªæ–­åœ¨ä¸åŒçš„å—ä¸­ã€‚ä¾‹å¦‚ï¼š

```plaintext
å—1: [228, 184]    // "ä¸­" çš„å‰ä¸¤ä¸ªå­—èŠ‚ï¼ˆä¸å®Œæ•´ï¼‰
å—2: [150]         // "ä¸­" çš„æœ€åä¸€ä¸ªå­—èŠ‚
```

`stream` é€‰é¡¹å†³å®šäº†è§£ç å™¨å¦‚ä½•å¤„ç†å¯èƒ½ä¸å®Œæ•´çš„å¤šå­—èŠ‚å­—ç¬¦ï¼š

| `stream` å€¼ | è¡Œä¸ºæè¿°                                                     |
| ----------- | ------------------------------------------------------------ |
| `false`     | é»˜è®¤å€¼ã€‚å‡è®¾è¾“å…¥æ˜¯**å®Œæ•´çš„**ï¼Œç›´æ¥è§£ç æ‰€æœ‰å­—èŠ‚ã€‚è‹¥é‡åˆ°ä¸å®Œæ•´å­—ç¬¦ï¼Œä¼šç”¨ `ï¿½` æ›¿æ¢ã€‚ |
| `true`      | å‡è®¾è¾“å…¥æ˜¯**æ•°æ®æµçš„ä¸€éƒ¨åˆ†**ï¼Œä¿ç•™æœªå®Œæˆçš„å¤šå­—èŠ‚å­—ç¬¦ï¼Œç­‰å¾…åç»­æ•°æ®ã€‚ |

å®é™…æƒ…å†µå¯ä»¥å‚è€ƒä¸‹æ®µä»£ç ï¼š

```js
// é”™è¯¯æƒ…å†µ
const decoder = new TextDecoder();
const chunk1 = new Uint8Array([228, 184]); // "ä¸­" çš„å‰ä¸¤ä¸ªå­—èŠ‚
const chunk2 = new Uint8Array([150]);      // "ä¸­" çš„æœ€åä¸€ä¸ªå­—èŠ‚

console.log(decoder.decode(chunk1)); // è¾“å‡º: "ï¿½"ï¼ˆé”™è¯¯ï¼šæˆªæ–­çš„å­—ç¬¦è¢«æ›¿æ¢ä¸ºä¹±ç ï¼‰
console.log(decoder.decode(chunk2)); // è¾“å‡º: "ï¿½"ï¼ˆé”™è¯¯ï¼šå•ç‹¬çš„ç¬¬ä¸‰ä¸ªå­—èŠ‚æ— æ³•ç»„æˆæœ‰æ•ˆå­—ç¬¦ï¼‰

// æ­£ç¡®æƒ…å†µ

const decoder = new TextDecoder();
const chunk1 = new Uint8Array([228, 184]); // "ä¸­" çš„å‰ä¸¤ä¸ªå­—èŠ‚
const chunk2 = new Uint8Array([150]);      // "ä¸­" çš„æœ€åä¸€ä¸ªå­—èŠ‚

console.log(decoder.decode(chunk1, { stream: true })); // è¾“å‡º: ""ï¼ˆæ— è¾“å‡ºï¼Œä¿ç•™æœªå®Œæˆå­—ç¬¦ï¼‰
console.log(decoder.decode(chunk2));                   // è¾“å‡º: "ä¸­"ï¼ˆåˆå¹¶åæ­£ç¡®è§£ç ï¼‰
```





### å¤„ç†æµå¼è¾“å‡º



ç»“åˆä¸Šè¿°APIçš„åˆ†æï¼Œ`fetch` å®ç°å¤„ç†æµå¼æ•°æ®çš„ä»£ç å¦‚ä¸‹ï¼š

```js
const controller = new AbortController()

const response = await fetch(
  url,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer sk-dd0e8892eb0445149fd21fd9b1d6176c`,
      'X-DashScope-SSE': 'enable',
    },
    signal: controller.signal,
    body: JSON.stringify({
      input: {
        prompt: text
      },
      parameters: {
        'incremental_output' : 'true' // å¢é‡è¾“å‡º
      },
    }),
  }
)
if (!response.ok) {
  message.error('AIè¿”å›é”™è¯¯')
  loadingSend.value = false
  return
}

const decoder = new TextDecoder('UTF-8')
const reader = response.body.getReader()

while (true) {
  const {done, value} = await reader.read();

  if (done) {
    console.log('æµè¯»å–å®Œæˆ');
    // ä¸­æ–­fetchè¯·æ±‚
    controller.abort()
    // èµ„æºé‡Šæ”¾ï¼šé‡Šæ”¾è¯»å–å™¨é”
    reader.releaseLock()
    break;
  }

  // è§£ç äºŒè¿›åˆ¶æ•°æ®ä¸ºæ–‡æœ¬
  const chunk = decoder.decode(value, { stream: true })
  console.log('chunk:===>', chunk)
}
```



### å¤„ç†æµå¼æ•°æ®



é€šè¿‡ `reader` è¯»å–åˆ°çš„æ•°æ®ç»è¿‡ `decoder` å¤„ç†åæ ¼å¼å¦‚ä¸‹ï¼š

```
id:1
event:result
:HTTP_STATUS/200
data:{"output":{"session_id":"0837b503363c4525a6609f868f3f6afa","finish_reason":"null","text":"æˆ‘æ˜¯","reject_status":false},"usage":{"models":[{"input_tokens":370,"output_tokens":1,"model_id":"deepseek-v3"}]},"request_id":"ecea2ce7-3867-9074-aa67-92b39ba9253a"}

id:2
event:result
:HTTP_STATUS/200
data:{"output":{"session_id":"0837b503363c4525a6609f868f3f6afa","finish_reason":"null","text":"ä½ çš„","reject_status":false},"usage":{"models":[{"input_tokens":370,"output_tokens":2,"model_id":"deepseek-v3"}]},"request_id":"ecea2ce7-3867-9074-aa67-92b39ba9253a"}
```

å½“ç„¶è¿™ä¸ªæ˜¯é˜¿é‡Œäº‘çš„è¿”å›æ ¼å¼ï¼Œä½†æµå¼æ•°æ®æ ¼å¼éƒ½å¤§å·®ä¸å·®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†æè¿™æ®µæ–‡æœ¬ã€‚

é¦–å…ˆï¼Œ`reader` è·å–çš„æ•°æ®å¯èƒ½ä¼šæœ‰å¤šæ®µï¼Œå¦‚ä¸Šæ–‡ä¸­çš„å°±æ˜¯ `id:1` å’Œ `id:2` ä¸¤æ®µæ•°æ®ã€‚

å…¶ä¸­å…³é”®å­—æ®µä¸ºï¼š`data.output.text` ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ¹æ®è¿”å›æ•°æ®çš„ç»“æ„ç‰¹ç‚¹é€šè¿‡æ­£åˆ™æŠŠæœ‰æ•ˆä¿¡æ¯ç»™è¿‡æ»¤å‡ºæ¥ã€‚

```js
// å…¨å±€è´ªå©ªåŒ¹é… "text":" åˆ° ","reject_status": ä¹‹é—´çš„å†…å®¹ï¼Œç¡®ä¿å¤šæ®µæ•°æ®ä¹Ÿèƒ½å‡†ç¡®æå–æ‰€æœ‰çš„æœ‰æ•ˆä¿¡æ¯
const regex = /"text":"(.*?)","reject_status":/gs;
```

è¿™é‡Œä½¿ç”¨æ­£åˆ™è€Œä¸æ˜¯ `JSON` åŒ–çš„åŸå› æ˜¯**æµå¼æ•°æ®çš„å¤„ç†è®²ç©¶é«˜æ•ˆä¸å‡†ç¡®**ï¼Œ`JSON` åŒ–æ›´åŠ åœ°æ¶ˆè€—æ€§èƒ½ï¼Œè€Œä¸”å­˜åœ¨å¼‚å¸¸æŠ¥é”™çš„å¯èƒ½ï¼Œä¸ºäº†æœ€å¤§å¯èƒ½ä¿è¯ä¸»æµç¨‹çš„æŒç»­è¾“å‡ºï¼Œç”¨æ­£åˆ™æ˜¯æ›´ä¼˜çš„é€‰æ‹©ã€‚å½“ç„¶å…·ä½“ä¸šåŠ¡åœºæ™¯å…·ä½“å¤„ç†ï¼Œè¿™é‡Œä»…ä½œä¸ªäººè§è§£ã€‚



æ ¹æ®ä¸Šè¿°æ­£åˆ™ï¼Œå®ç°ä¸€ä¸ªæ•°æ®å¤„ç†å‡½æ•°ï¼š

```js
const extractText = (jsonString) => {
  try {
    const regex = /"text":"(.*?)","reject_status":/gs;
    let match;
    let result = '';
    // åˆ©ç”¨regex.exec()åœ¨å­—ç¬¦ä¸²é‡Œå¾ªç¯æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…ç»“æœï¼ŒæŠŠæ¯æ¬¡åŒ¹é…å¾—åˆ°çš„æ•è·ç»„å†…å®¹ï¼ˆä¹Ÿå°±æ˜¯textå­—æ®µçš„å€¼ï¼‰æ·»åŠ åˆ°resultå­—ç¬¦ä¸²ä¸­ã€‚
    while ((match = regex.exec(jsonString)) !== null) {
      // å°†å­—ç¬¦ä¸²é‡Œçš„\nè½¬ä¹‰åºåˆ—è½¬æ¢ä¸ºçœŸæ­£çš„æ¢è¡Œç¬¦ï¼ŒæŠŠ\"è½¬ä¹‰åºåˆ—è¿˜åŸä¸ºæ™®é€šçš„åŒå¼•å·ã€‚
      result += match[1].replace(/\\n/g, '\n').replace(/\\"/g, '"');
    }
    return result
  } catch (error) {
    console.log('error', error)
    return ''
  }
}
```



æœ€åæŠŠæ•°æ®å¤„ç†å‡½æ•°åŠ åˆ°æµå¼è¾“å‡ºä»£ç ä¸­ï¼Œé€šè¿‡ç¼“å­˜æŒç»­è·å–æœ‰ç”¨çš„ä¿¡æ¯ï¼š

```js
...
// ç”¨äºç´¯è®¡æ¥æ”¶åˆ°çš„æ•°æ®
let accumulatedText = ''

while (true) {
  const {done, value} = await reader.read();

  if (done) {
    ...
    break;
  }

  const chunk = decoder.decode(value, { stream: true })
  // ç´¯åŠ å¹¶æ¸²æŸ“æ•°æ®
  const newText = extractText(chunk)
  if (newText) {
  	accumulatedText += newText
  }
}
```



### è½¬æ¢MDæ–‡æœ¬



è¿™é‡Œç”¨åˆ°å‡ ä¸ªåº“æ¥å®ç°ï¼š

- `markdown-it` ä¸€ä¸ªå¿«é€Ÿã€åŠŸèƒ½ä¸°å¯Œçš„ Markdown è§£æå™¨ï¼ŒåŸºäº JavaScript å®ç°ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æŠŠ Markdown æ–‡æœ¬è½¬æ¢æˆ HTMLã€‚
- `@vscode/markdown-it-katex` VS Code å›¢é˜Ÿå¼€å‘çš„æ’ä»¶ï¼Œç”¨äºåœ¨ Markdown ä¸­æ¸²æŸ“ LaTeX æ•°å­¦å…¬å¼ï¼Œå®ƒé›†æˆäº† KaTeX è¿™ä¸ªå¿«é€Ÿçš„æ•°å­¦å…¬å¼æ¸²æŸ“å¼•æ“ã€‚
- `markdown-it-link-attributes` ä¸º Markdown ä¸­çš„é“¾æ¥æ·»åŠ è‡ªå®šä¹‰å±æ€§ï¼Œæ¯”å¦‚ä¸ºå¤–éƒ¨é“¾æ¥æ·»åŠ `target="_blank"`å’Œ`rel="noopener noreferrer"`å±æ€§ã€‚
- `mermaid-it-markdown` ç”¨äºåœ¨ Markdown ä¸­é›†æˆ Mermaid å›¾è¡¨ï¼ŒMermaid æ˜¯ä¸€ç§ç”¨æ–‡æœ¬è¯­æ³•æè¿°å›¾è¡¨çš„å·¥å…·ã€‚



#### ä¸‰æ–¹åº“ä½¿ç”¨

ç»“åˆä¸Šè¿°å„ç§åº“ç»“åˆï¼Œå¤„ç†æ¥å£è¿”å›çš„ä¿¡æ¯æµï¼š

```js
import MarkdownIt from 'markdown-it'
import MdKatex from '@vscode/markdown-it-katex'
import MdLinkAttributes from 'markdown-it-link-attributes'
import MdMermaid from 'mermaid-it-markdown'
import hljs from 'highlight.js'

const mdi = new MarkdownIt({
  html: false,
  linkify: true,
  highlight(code, language) {
    const validLang = !!(language && hljs.getLanguage(language))
    if (validLang) {
      const lang = language ?? ''
      return highlightBlock(hljs.highlight(code, { language: lang }).value, lang)
    }
    return highlightBlock(hljs.highlightAuto(code).value, '')
  },
})
mdi.use(MdLinkAttributes, { attrs: { target: '_blank', rel: 'noopener' } }).use(MdKatex).use(MdMermaid)

// å®ç°ä»£ç å—å¿«é€Ÿå¤åˆ¶
function highlightBlock(str, lang) {
  return `<pre class="code-block-wrapper">
            <div class="code-block-header">
                <span class="code-block-header__lang">${lang}</span>
                <span class="code-block-header__copy">å¤åˆ¶ä»£ç </span>
            </div>
            <code class="hljs code-block-body ${lang}"><br>${str}</code>
          </pre>`
}

const renderToAI = (text) => {
  // å¯¹æ•°å­¦å…¬å¼è¿›è¡Œå¤„ç†ï¼Œè‡ªåŠ¨æ·»åŠ  $$ ç¬¦å·
  const escapedText = escapeBrackets(escapeDollarNumber(text))
  return mdi.render(escapedText)
}

const escapeBrackets = (text) => {
  const pattern = /(```[\s\S]*?```|`.*?`)|\\\[([\s\S]*?[^\\])\\]|\\\((.*?)\\\)/g
  return text.replace(pattern, (match, codeBlock, squareBracket, roundBracket) => {
    if (codeBlock)
      return codeBlock
    else if (squareBracket)
      return `$$${squareBracket}$$`
    else if (roundBracket)
      return `$${roundBracket}$`
    return match
  })
}

const escapeDollarNumber = (text) => {
  let escapedText = ''

  for (let i = 0; i < text.length; i += 1) {
    let char = text[i]
    const nextChar = text[i + 1] || ' '

    if (char === '$' && nextChar >= '0' && nextChar <= '9')
      char = '\\$'

    escapedText += char
  }

  return escapedText
}
```



#### å¤åˆ¶ä»£ç å—

å¿«é€Ÿå¤åˆ¶ä»£ç å®ç°ï¼š

```js
// èŠå¤©åˆ—è¡¨ä¸»ä½“å…ƒç´ 
const textRef = ref()

// æ„å»ºtextareaï¼Œå°†å†…å®¹å¤åˆ¶åˆ°å‰ªåˆ‡æ¿
const copyToClip = (text) => {
  return new Promise((resolve, reject) => {
    try {
      const input = document.createElement('textarea')
      input.setAttribute('readonly', 'readonly')
      input.value = text
      document.body.appendChild(input)
      input.select()
      if (document.execCommand('copy'))
        document.execCommand('copy')
      document.body.removeChild(input)
      resolve(text)
    }
    catch (error) {
      reject(error)
    }
  })
}

// ä¸ºæ‰€æœ‰çš„å¤åˆ¶ä»£ç æŒ‰é’®æ·»åŠ å¤åˆ¶äº‹ä»¶
const addCopyEvents = () => {
  if (textRef.value) {
    const copyBtn = textRef.value.querySelectorAll('.code-block-header__copy')
    copyBtn.forEach((btn) => {
      btn.addEventListener('click', () => {
        const code = btn.parentElement?.nextElementSibling?.textContent
        if (code) {
          copyToClip(code).then(() => {
            btn.textContent = 'å¤åˆ¶æˆåŠŸ'
            setTimeout(() => {
              btn.textContent = 'å¤åˆ¶ä»£ç '
            }, 1000)
          })
        }
      })
    })
  }
}

// ç§»é™¤é¡µé¢ä¸­æ‰€æœ‰çš„å¤åˆ¶äº‹ä»¶
const removeCopyEvents = () => {
  if (textRef.value) {
    const copyBtn = textRef.value.querySelectorAll('.code-block-header__copy')
    copyBtn.forEach((btn) => {
      btn.removeEventListener('click', () => { })
    })
  }
}

// åœ¨åˆé€‚çš„ç”Ÿå‘½å‘¨æœŸé‡Œæ³¨å†Œæˆ–å¸è½½é‡æ–°äº‹ä»¶

// å¯ä»¥åœ¨æµå¼è¾“å‡ºå®Œæˆï¼Œé¡µé¢æ¸²æŸ“å®Œæˆçš„æ—¶å€™æ‰‹åŠ¨è°ƒç”¨ï¼Œé¿å…æ€§èƒ½æµªè´¹ï¼Œæ›´åŠ åˆç†
onUpdated(() => {
  addCopyEvents()
})

onUnmounted(() => {
  removeCopyEvents()
})
```



#### è‡ªå®šä¹‰MDæ ·å¼

MDæ ·å¼ï¼š

```css
.ai-message {
    background-color: transparent;
    font-size: 14px;
}
.ai-message p {
    white-space: pre-wrap;
}
.ai-message ol {
    list-style-type: decimal;
}
.ai-message ul {
    list-style-type: disc;
}
.ai-message pre code,
.ai-message pre tt {
    line-height: 1.65;
}
.ai-message .highlight pre,
.ai-message pre {
    background-color: #fff;
}
.ai-message code.hljs {
    padding: 0;
}
.ai-message .code-block-wrapper {
    position: relative;
    padding: 0 12px;
    border-radius: 8px;
}
.ai-message .code-block-header {
    position: absolute;
    top: 5px;
    right: 0;
    width: 100%;
    padding: 0 1rem;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    color: #b3b3b3;
}
.ai-message .code-block-header__copy {
    cursor: pointer;
    margin-left: 0.5rem;
    user-select: none;
}
.ai-message .code-block-header__copy:hover {
    color: #65a665;
}
.ai-message div[id^='mermaid-container'] {
    padding: 4px;
    border-radius: 4px;
    overflow-x: auto !important;
    background-color: #fff;
    border: 1px solid #e5e5e5;
}
.ai-message li {
    margin-left: 16px;
    box-sizing: border-box;
}
```



æœ€åï¼ŒæŠŠå¤„ç†å‡½æ•°è¿½åŠ åˆ°å¤„ç†æµå¼æ•°æ®åé¢ï¼š

```js
let mdHtml = ''

...
const chunk = decoder.decode(value, { stream: true })
const newText = extractText(chunk)
if (newText) {
  accumulatedText += newText
  mdHtml += renderToAI(accumulatedText)
}
```



### æ‰“å­—æœº



åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å·²ç»æµå¼åœ°æ‹¿åˆ°äº†æ¥å£è¿”å›çš„æ•°æ®å¹¶ä¸”è½¬æ¢æˆäº†é¡µé¢å¯ä»¥å±•ç¤ºçš„MDé£æ ¼HTMLå­—ç¬¦ä¸²ã€‚

æ‰“å­—æœºçš„åŸºæœ¬æ€è·¯å°±æ˜¯æŒ‰ç…§ä¸€å®šé¢‘ç‡æŠŠå†…å®¹æ·»åŠ åˆ°é¡µé¢ä¸Šï¼Œå¹¶ä¸”åœ¨å†…å®¹æœ€å‰é¢åŠ ä¸ªæ‰“å­—çš„å…‰æ ‡ã€‚



ç›´æ¥ä¸Šä»£ç ï¼š

```vue
<template>
  <div v-html="displayText + `${ showCursor || adding ? `<span class='cursors'>_</span>`:'' }`"></div>
</template>

<script setup>
import { ref, watch, onUnmounted } from 'vue';

const props = defineProps({
  // è¦æ˜¾ç¤ºçš„å®Œæ•´æ–‡æœ¬
  text: {
    type: String,
    required: true
  },
  // æ‰“å­—é€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ç¬¦ï¼‰
  speed: {
    type: Number,
    default: 10
  },
  showCursor: {
    type: Boolean,
    default: false
  },
  break: {
    type: Boolean,
    default: false
  },
});
const emits = defineEmits(['update', 'ok'])

const displayText = ref('');
const adding = ref(false);
let timer = null;

// æ›´æ–°æ˜¾ç¤ºçš„æ–‡æœ¬
const updateDisplayText = () => {
  if (displayText.value.length < props.text.length) {
    adding.value = true;
    displayText.value = props.text.substring(0, displayText.value.length + 1);
    emits('update')
    timer = setTimeout(updateDisplayText, props.speed);
  } else {
    adding.value = false;
    setTimeout(() =>{
      emits('ok')
    } ,600)
  }
};

// å¢é‡æ›´æ–°
watch(() => props.text, (newText) => {
  // å¦‚æœæ–°æ–‡æœ¬æ¯”å½“å‰æ˜¾ç¤ºçš„æ–‡æœ¬é•¿ï¼Œåˆ™ç»§ç»­æ‰“å­—
  if (newText.length > displayText.value.length) {
    clearTimeout(timer);
    updateDisplayText();
  }
});

// åœæ­¢å›ç­”
watch(() => props.break, (val) => {
  if (val) {
    displayText.value = props.text + ''
    clearTimeout(timer);
    adding.value = false;
    setTimeout(() =>{
      emits('ok')
    } ,600)
  }
});

// åˆå§‹åŒ–
updateDisplayText();

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
onUnmounted(() => {
  clearTimeout(timer);
});
</script>

<style>

.cursors {
  font-weight: 700;
  vertical-align: baseline;
  animation: blink 1s infinite;
  color: #3a5ccc;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}
</style>  
```



æˆ‘ä»¬åªéœ€è¦æŠŠä¸Šè¿°è½¬æ¢çš„MDæ–‡æœ¬ä¼ å…¥è¿™ä¸ªç»„ä»¶å°±èƒ½å®ç°æ‰“å­—æœºæ•ˆæœã€‚

```vue
<temlate>
	<div class="ai-message">
    <TypingEffect :text="text" :showCursor="!ready" :break="break" @update="updateAIText" @ok="textAllShow" />
  </div>
</temlate>
```



éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰“å­—æœºæ‰“å°çš„é€Ÿåº¦æ˜¯æŒ‰ç…§æ’å®šé€Ÿåº¦æ‰§è¡Œçš„ï¼Œæµå¼æ•°æ®æ˜¯ä¸è§„åˆ™æ—¶é—´è¿”å›çš„ï¼Œæœ‰å¯èƒ½è¿”å›å¾ˆå¿«ï¼Œä¹Ÿæœ‰å¯èƒ½è¿”å›å¾ˆæ…¢ï¼Œæ‰€ä»¥ä¸¤è¾¹å°±ä¼šæœ‰æ—¶é—´å·®ã€‚

è¿™å°±é€ æˆäº†ä¸€ç§ç°è±¡ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ç‚¹äº†åœæ­¢å›ç­”çš„æŒ‰é’®ï¼Œé¡µé¢ä¸Šè¿˜åœ¨ä¸æ–­è¾“å‡ºå†…å®¹ï¼Œå¥½åƒæ²¡æœ‰æ‰“æ–­è¿™æ¬¡å›ç­”ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦åœ¨ç‚¹å‡»åœæ­¢å›ç­”çš„æ—¶å€™ç»ˆæ­¢æ‰“å­—æœºçš„è½®è¯¢ï¼Œç›´æ¥å±•ç¤ºå®Œæ•´æ•°æ®å³å¯ã€‚



æœ€åä¼˜åŒ–æ˜¾ç¤ºï¼Œéœ€è¦è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼š

```js
const scrollToBottom = () => {
  try {
    const { height } = textRef.value.getBoundingClientRect()
    textRef.value.scrollTo({
      top: textRef.value.scrollHeight - height,
      behavior: 'smooth',
    })
  } catch (e) {}
}
```



### æ€»ç»“



å‰ç«¯AIåœºæ™¯ä¸‹æ€»ç»“æ¥è¯´å°±ä¸¤ä¸ªå¹³æ—¶ä¸å¸¸è§çš„æŠ€æœ¯ç‚¹ï¼š

- æµå¼è¾“å‡º
- è¯·æ±‚ä¸­æ–­

å½“ç„¶æœ¬ç¯‡æ–‡ç« åªæ˜¯å®ç°äº†åŸºæœ¬çš„AIåœºæ™¯ï¼Œåƒä¸Šä¸‹æ–‡è®°å¿†ã€å¤šå¯¹è¯æ¡†ä»¥åŠæ›´å¤§æ¨¡å‹çš„å¾®è°ƒç­‰ç­‰å¹¶æœªæ¶‰åŠåˆ°ï¼Œè¿™äº›æ›´åŠ æ·±å…¥åœ°åŠŸèƒ½ï¼Œå¯ä»¥åé¢æ…¢æ…¢ç ”ç©¶ï¼Œé‚£ä¹ˆï¼Œè¿™æ¬¡å°±åˆ°è¿™é‡Œ~

